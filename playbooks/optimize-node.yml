---
- name: K3s Production Node Optimization
  hosts: localhost
  connection: local
  become: yes
  gather_facts: yes

  vars:
    # Kernel parameters
    kernel_params:
      # Network performance
      net.core.somaxconn: 32768
      net.core.netdev_max_backlog: 16384
      net.ipv4.tcp_max_syn_backlog: 8096
      net.ipv4.tcp_slow_start_after_idle: 0
      net.ipv4.tcp_tw_reuse: 1
      net.ipv4.ip_local_port_range: "1024 65535"
      net.ipv4.tcp_fin_timeout: 30
      net.ipv4.tcp_keepalive_time: 600
      net.ipv4.tcp_keepalive_probes: 3
      net.ipv4.tcp_keepalive_intvl: 15
      
      # Memory management
      vm.swappiness: 1
      vm.dirty_ratio: 10
      vm.dirty_background_ratio: 5
      vm.vfs_cache_pressure: 50
      vm.min_free_kbytes: 131072
      
      # Kubernetes specific
      net.bridge.bridge-nf-call-iptables: 1
      net.bridge.bridge-nf-call-ip6tables: 1
      net.ipv4.ip_forward: 1
      
      # File descriptors
      fs.file-max: 2097152
      fs.inotify.max_user_watches: 524288
      fs.inotify.max_user_instances: 512
      
      # Connection tracking
      net.netfilter.nf_conntrack_max: 1048576
      net.netfilter.nf_conntrack_tcp_timeout_established: 86400
    
    # Zram configuration
    zram_size_mb: 768
    zram_compression: lz4
    
    # System limits
    system_limits:
      - domain: '*'
        type: soft
        item: nofile
        value: 65536
      - domain: '*'
        type: hard
        item: nofile
        value: 65536
      - domain: '*'
        type: soft
        item: nproc
        value: 32768
      - domain: '*'
        type: hard
        item: nproc
        value: 32768

  tasks:
    - name: Display optimization header
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘  K3s Master Node Self-Optimization                            â•‘
          â•‘  Node: {{ ansible_hostname }}                                 â•‘
          â•‘  RAM: {{ ansible_memtotal_mb }} MB                            â•‘
          â•‘  CPU: {{ ansible_processor_vcpus }} cores                     â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    #########################################################################
    # 1. KERNEL MODULES
    #########################################################################
    - name: Load required kernel modules
      modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - overlay
        - br_netfilter
        - nf_conntrack
        - zram

    - name: Ensure kernel modules load on boot
      copy:
        content: |
          overlay
          br_netfilter
          nf_conntrack
          zram
        dest: /etc/modules-load.d/k3s.conf
        mode: '0644'

    #########################################################################
    # 2. SYSCTL TUNING
    #########################################################################
    - name: Apply kernel parameters
      sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        state: present
        reload: yes
        sysctl_file: /etc/sysctl.d/99-k3s-optimization.conf
      loop: "{{ kernel_params | dict2items }}"

    #########################################################################
    # 3. SYSTEM LIMITS
    #########################################################################
    - name: Configure system limits
      pam_limits:
        domain: "{{ item.domain }}"
        limit_type: "{{ item.type }}"
        limit_item: "{{ item.item }}"
        value: "{{ item.value }}"
      loop: "{{ system_limits }}"

    #########################################################################
    # 4. ZRAM SWAP
    #########################################################################
    - name: Install zram-tools
      apt:
        name: zram-tools
        state: present
        update_cache: yes
      when: ansible_os_family == 'Debian'

    - name: Configure zram-tools
      lineinfile:
        path: /etc/default/zramswap
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        create: yes
      loop:
        - { regexp: '^ALGO=', line: 'ALGO={{ zram_compression }}' }
        - { regexp: '^PERCENT=', line: 'PERCENT=25' }
      when: ansible_os_family == 'Debian'
      notify: restart zram

    - name: Create zram swap script (non-Debian)
      copy:
        content: |
          #!/bin/bash
          modprobe zram
          echo {{ zram_compression }} > /sys/block/zram0/comp_algorithm
          echo {{ zram_size_mb }}M > /sys/block/zram0/disksize
          mkswap /dev/zram0
          swapon -p 5 /dev/zram0
        dest: /usr/local/bin/setup-zram.sh
        mode: '0755'
      when: ansible_os_family != 'Debian'

    - name: Create zram systemd service (non-Debian)
      copy:
        content: |
          [Unit]
          Description=zram swap
          After=multi-user.target

          [Service]
          Type=oneshot
          ExecStart=/usr/local/bin/setup-zram.sh
          RemainAfterExit=yes

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/zram.service
      when: ansible_os_family != 'Debian'
      notify: enable and start zram service

    #########################################################################
    # 5. DISABLE UNNECESSARY SERVICES
    #########################################################################
    - name: Disable unnecessary services
      systemd:
        name: "{{ item }}"
        enabled: no
        state: stopped
      loop:
        - snapd
        - bluetooth
      failed_when: false

    #########################################################################
    # 6. INSTALL MONITORING TOOLS
    #########################################################################
    - name: Install monitoring utilities
      apt:
        name:
          - htop
          - iotop
          - nethogs
          - sysstat
          - curl
          - jq
        state: present

    #########################################################################
    # 7. CONFIGURE LOG ROTATION
    #########################################################################
    - name: Configure logrotate for K3s
      copy:
        content: |
          /var/log/k3s/*.log {
              daily
              rotate 7
              compress
              delaycompress
              missingok
              notifempty
              create 0640 root root
          }
        dest: /etc/logrotate.d/k3s
        mode: '0644'

    #########################################################################
    # 8. TIME SYNC
    #########################################################################
    - name: Ensure chrony is running
      systemd:
        name: chronyd
        enabled: yes
        state: started
      failed_when: false

    #########################################################################
    # 9. DISK OPTIMIZATION
    #########################################################################
    - name: Enable fstrim timer
      systemd:
        name: fstrim.timer
        enabled: yes
        state: started
      failed_when: false

    #########################################################################
    # 10. CREATE HEALTH CHECK SCRIPT
    #########################################################################
    - name: Create health check script
      copy:
        content: |
          #!/bin/bash
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "K3s Node Health Check - $(date)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Memory:"
          free -h
          echo ""
          echo "ğŸ“Š Swap (zram):"
          swapon --show
          echo ""
          echo "ğŸ“Š Disk:"
          df -h /
          echo ""
          echo "ğŸ“Š K3s Status:"
          systemctl status k3s --no-pager | head -10
          echo ""
          echo "ğŸ“Š Pod Count:"
          kubectl get pods -A --no-headers 2>/dev/null | wc -l
          echo ""
          echo "ğŸ“Š Node Status:"
          kubectl get nodes 2>/dev/null
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        dest: /usr/local/bin/k3s-health-check
        mode: '0755'

    - name: Display completion message
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘  âœ… Node Optimization Complete!                                â•‘
          â•‘                                                                â•‘
          â•‘  Run health check: /usr/local/bin/k3s-health-check            â•‘
          â•‘  View logs: tail -f /opt/k3s-ansible/logs/ansible.log         â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  handlers:
    - name: restart zram
      systemd:
        name: zramswap
        state: restarted

    - name: enable and start zram service
      systemd:
        name: zram
        enabled: yes
        state: started
        daemon_reload: yes
