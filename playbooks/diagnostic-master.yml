---
- name: K3s Master Node Diagnostic
  hosts: localhost
  connection: local
  become: yes
  gather_facts: yes

  tasks:
    - name: Get system info
      shell: |
        echo "HOST: $(hostname)"
        echo "UPTIME: $(uptime -p)"
        echo "LOAD: $(uptime | awk -F'load average:' '{print $2}')"
      register: sys_info
      changed_when: false

    - name: Get K3s status
      shell: |
        systemctl is-active k3s 2>/dev/null || echo "INACTIVE"
      register: k3s_status
      changed_when: false

    - name: Get pod statistics
      shell: |
        kubectl get pods -A --no-headers 2>/dev/null | awk '
        {total++}
        $4=="Running"{running++}
        $4=="Pending"{pending++}
        $4=="Failed"{failed++}
        $4~/Crash|Error/{crashed++}
        END{
          print "TOTAL:"total" RUNNING:"running" PENDING:"pending" FAILED:"failed" CRASHED:"crashed
        }'
      register: pod_stats
      changed_when: false
      failed_when: false

    - name: Get resource usage
      shell: |
        free -h | awk 'NR==2{printf "RAM: %s/%s (%.0f%%)\n", $3,$2,($3/$2)*100}'
        df -h / | awk 'NR==2{printf "DISK: %s/%s (%s)\n", $3,$2,$5}'
      register: resources
      changed_when: false

    - name: Get critical pods
      shell: |
        kubectl get pods -A --no-headers 2>/dev/null | grep -vE 'Running|Completed' | head -5 || echo "All pods healthy"
      register: critical_pods
      changed_when: false
      failed_when: false

    - name: Display Master Node Status
      debug:
        msg: |
          ╔══════════════════════════════════════════════════════════╗
          ║           K3S MASTER NODE DIAGNOSTIC                     ║
          ╠══════════════════════════════════════════════════════════╣
          ║ SYSTEM INFO                                              ║
          ║ {{ sys_info.stdout_lines | join('\n║ ') }}
          ║                                                          ║
          ║ K3S SERVICE                                              ║
          ║ Status: {{ k3s_status.stdout }}
          ║                                                          ║
          ║ POD STATISTICS                                           ║
          ║ {{ pod_stats.stdout }}
          ║                                                          ║
          ║ RESOURCES                                                ║
          ║ {{ resources.stdout_lines | join('\n║ ') }}
          ║                                                          ║
          ║ CRITICAL PODS (non-Running)                              ║
          ║ {{ critical_pods.stdout_lines[:3] | join('\n║ ') if critical_pods.stdout_lines else '║ None - All healthy!' }}
          ╚══════════════════════════════════════════════════════════╝
