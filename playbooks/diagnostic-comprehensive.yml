---
- name: Comprehensive K3s Node Conflict Diagnostics
  hosts: localhost
  connection: local
  become: yes
  gather_facts: yes

  vars:
    diagnostic_output: []
    errors: []
    warnings: []
    ok_checks: []

  tasks:
    # ... (блоки без изменений) ...
    #########################################################################
    # 3. PORT CONFLICTS CHECK (final fix)
    #########################################################################
    - name: Get honeypot PID
      shell: "ps aux | grep '[h]oneypot.py' | awk '{print $2}'"
      register: honeypot_pid
      changed_when: false
      failed_when: false

    - name: Check for port conflicts (exclude K3s etcd ports 2379, 2380)
      shell: |
        netstat -tlnp 2>/dev/null | awk 'NR>2 {print $4, $7}' | \
          awk -F: '{print $NF}' | grep -Ev '^ *$|2379|2380' | \
          sort | uniq -c | awk '$1 > 1 {print "⚠️  Port", $2, "used by", $1, "processes"}'
      register: port_conflicts
      changed_when: false
      failed_when: false

    - name: Check honeypot vs real service ports (exclude honeypot PID)
      shell: |
        honeypot_pid='{{ honeypot_pid.stdout }}'
        if [ -z "$honeypot_pid" ]; then exit 0; fi
        honeypot_ports="21 22 23 25 110 143 3306 3389 5432"
        conflicts=""
        for port in $honeypot_ports; do
          real_service=$(netstat -tlnp 2>/dev/null | grep ":$port " | grep -v "$honeypot_pid" | grep -v honeypot | awk '{print $7}')
          if [ -n "$real_service" ]; then
            conflicts="${conflicts}❌ Port $port: honeypot conflicts with $real_service\n"
          fi
        done
        if [ -n "$conflicts" ]; then
          printf "%b" "$conflicts"
        fi
      register: honeypot_conflicts
      changed_when: false
      failed_when: false

    - name: Add port conflicts to results
      set_fact:
        diagnostic_output: "{{ diagnostic_output + [port_conflicts.stdout | trim] }}"
      when: port_conflicts.stdout | trim != ""

    - name: Add honeypot conflicts to results
      set_fact:
        diagnostic_output: "{{ diagnostic_output + [honeypot_conflicts.stdout | trim] }}"
      when: honeypot_conflicts.stdout | trim != ""

    # ... (остальные задачи без изменений) ...
    #########################################################################
    # 4. SYSTEMD SERVICE CONFLICTS (no 'enabled' output)
    #########################################################################
    - name: Detect main network interface
      shell: "ip route get 1 | awk '{print $5; exit}'"
      register: main_iface
      changed_when: false

    - name: Check for failed security services (no enabled spam)
      shell: |
        main_iface='{{ main_iface.stdout }}'
        failures=""
        services=(fail2ban psad arpwatch-${main_iface} arpwatch-cni0 honeypot)
        for service in "${services[@]}"; do
          is_enabled=$(systemctl is-enabled "$service" 2>/dev/null)
          status=$(systemctl is-active "$service" 2>/dev/null)
          if [[ "$is_enabled" == "enabled" && "$status" != "active" ]]; then
            failures="${failures}❌ $service: $status\n"
          fi
        done
        if [ -n "$failures" ]; then printf "%b" "$failures"; fi
      register: service_failures
      changed_when: false
      failed_when: false

    - name: Add service failures to results
      set_fact:
        diagnostic_output: "{{ diagnostic_output + [service_failures.stdout | trim] }}"
      when: service_failures.stdout | trim != ""

    # ... (остальные задачи без изменений) ...