# Ansible K3s Optimization

üöÄ **Production-ready Ansible playbooks** –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ K3s –∫–ª–∞—Å—Ç–µ—Ä–∞, security hardening, honeypot deployment –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏.

## üìä –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ –∞—É–¥–∏—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

### –ë—ã—Å—Ç—Ä–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (CLI)

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤—ã—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ:
```bash
sudo /usr/local/bin/k3s-conflict-check
```

- –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –≤—ã–≤–æ–¥
- –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –∏ exit-–∫–æ–¥ –ø–æ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏

### –ì–ª—É–±–æ–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (Ansible)

–ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤—Å–µ —Ç–∏–ø—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤, —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –∏ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤:
```bash
ansible-playbook playbooks/diagnostic-comprehensive.yml
```

- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–±–ª–µ–º –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- –ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∏—Ä—É–µ—Ç: –æ—à–∏–±–∫–∏ (‚ùå), –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (‚ö†Ô∏è), –û–ö (‚úÖ)
- –ò—Ç–æ–≥–æ–≤—ã–π summary + –ø–æ–¥—Ä–æ–±–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

- –°–∫—Ä–∏–ø—Ç `/usr/local/bin/k3s-conflict-check` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥–æ–µ —É—Ç—Ä–æ cron-–æ–º
- –õ–æ–≥ –¥–æ—Å—Ç—É–ø–µ–Ω: `/var/log/k3s-conflict-check.log`
- –†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤ –Ω–∞ 7 –¥–Ω–µ–π

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

```bash
ansible-playbook playbooks/install-diagnostic-tools.yml
```

## üîß –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

–ü–æ—Å–ª–µ `git pull` –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π:

```bash
# 1. –û–±–Ω–æ–≤–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
ansible-playbook playbooks/install-diagnostic-tools.yml

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
ansible-playbook playbooks/diagnostic-comprehensive.yml
# –ò–õ–ò –±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:
sudo /usr/local/bin/k3s-conflict-check

# 3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é PSAD (–µ—Å–ª–∏ –æ–±–Ω–æ–≤–ª—è–ª–∞—Å—å —Ä–æ–ª—å psad)
ansible-playbook playbooks/setup-security.yml --tags psad
```

**‚ö†Ô∏è –í–∞–∂–Ω–æ**: –ù–µ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ —Ñ–∞–π–ª—ã –∏–∑ `roles/*/tasks/main.yml` –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ `ansible-playbook` ‚Äî —ç—Ç–æ –∑–∞–¥–∞—á–∏ —Ä–æ–ª–µ–π, –∞ –Ω–µ playbook'–∏!

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Ansible 2.9+
- Ubuntu 20.04/22.04 –∏–ª–∏ Debian 11/12
- Root –∏–ª–∏ sudo –¥–æ—Å—Ç—É–ø
- Python 3.8+

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
git clone https://github.com/KomarovAI/ansible-k3s-optimization.git
cd ansible-k3s-optimization

# –°–æ–∑–¥–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
python3 -m venv ansible-venv
source ansible-venv/bin/activate

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pip install -r requirements.txt
ansible-galaxy install -r requirements.yml
```

### –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```bash
# –ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
ansible-playbook playbooks/setup-security.yml

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ honeypot
ansible-playbook playbooks/setup-security.yml --tags honeypot

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ fail2ban
ansible-playbook playbooks/setup-security.yml --tags fail2ban

# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã
ansible-playbook playbooks/optimize-system.yml
```

---

## üìö –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
ansible-k3s-optimization/
‚îú‚îÄ‚îÄ playbooks/
‚îÇ   ‚îú‚îÄ‚îÄ setup-security.yml           # –û—Å–Ω–æ–≤–Ω–æ–π playbook –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
‚îÇ   ‚îú‚îÄ‚îÄ optimize-system.yml          # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã
‚îÇ   ‚îú‚îÄ‚îÄ diagnostic-comprehensive.yml # –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
‚îÇ   ‚îî‚îÄ‚îÄ install-diagnostic-tools.yml # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ CLI –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
‚îú‚îÄ‚îÄ roles/
‚îÇ   ‚îú‚îÄ‚îÄ fail2ban/                    # –ó–∞—â–∏—Ç–∞ –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞
‚îÇ   ‚îú‚îÄ‚îÄ psad/                        # Port Scan Attack Detector
‚îÇ   ‚îú‚îÄ‚îÄ honeypot/                    # Multi-port honeypot
‚îÇ   ‚îú‚îÄ‚îÄ arpwatch/                    # ARP spoofing detection
‚îÇ   ‚îú‚îÄ‚îÄ ipset/                       # IP blacklist management
‚îÇ   ‚îú‚îÄ‚îÄ xt_recent/                   # Rate limiting
‚îÇ   ‚îî‚îÄ‚îÄ ssh_security/                # SSH hardening
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ conflict-check.sh            # CLI —É—Ç–∏–ª–∏—Ç–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
‚îî‚îÄ‚îÄ inventory/
    ‚îî‚îÄ‚îÄ hosts.yml                    # –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å —Ö–æ—Å—Ç–æ–≤
```

---

## üõ°Ô∏è –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### Fail2ban
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏ –±—Ä—É—Ç—Ñ–æ—Ä—Å–µ SSH
- –ó–∞—â–∏—Ç–∞ honeypot –ø–æ—Ä—Ç–æ–≤
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ipset

### PSAD (Port Scan Attack Detector)
- –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Ä—Ç–æ–≤
- Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ postfix warnings)
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å iptables LOG

### Honeypot
- Multi-port honeypot (21, 22, 23, 25, 110, 143, 3306, 3389, 5432)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞—Ç–∞–∫—É—é—â–∏—Ö

### ARPwatch
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏–∑–º–µ–Ω–µ–Ω–∏–π MAC-–∞–¥—Ä–µ—Å–æ–≤
- –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ ARP spoofing –∞—Ç–∞–∫
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–µ—Ç–µ–≤–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (ens3, eth0, etc.)

### IPSet
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ blacklist
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ iptables
- Fail2ban –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### xt_recent
- Rate limiting –¥–ª—è SSH
- –ó–∞—â–∏—Ç–∞ –æ—Ç port scanning
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞

---

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ - –î–µ—Ç–∞–ª–∏

### –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:

1. **iptables –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã** - –î—É–±–ª–∏–∫–∞—Ç—ã –ø—Ä–∞–≤–∏–ª, –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ —Ü–µ–ø–æ—á–∫–∏
2. **sysctl –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã** - –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —è–¥—Ä–∞
3. **–ü–æ—Ä—Ç—ã** - –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø–æ—Ä—Ç–æ–≤, honeypot vs —Ä–µ–∞–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
4. **–°–µ—Ä–≤–∏—Å—ã** - –°—Ç–∞—Ç—É—Å fail2ban, psad, honeypot, arpwatch
5. **Kernel –º–æ–¥—É–ª–∏** - –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã xt_recent/ipt_recent, –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –º–æ–¥—É–ª–∏
6. **ipset** - –î—É–±–ª–∏–∫–∞—Ç—ã, –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ sets
7. **xt_recent** - –†–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å rate limiting
8. **–†–µ—Å—É—Ä—Å—ã** - CPU, Memory, Disk usage
9. **ARPwatch** - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö

### –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:

- **‚úÖ 9/9 checks passed** - –í—Å—ë –û–ö, –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –Ω–µ—Ç
- **‚ö†Ô∏è WARNINGS** - –ù–µ–∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
- **‚ùå ERRORS** - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã, —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

---

## ü§ù Contributing

–ü—É–ª–ª-—Ä–µ–∫–≤–µ—Å—Ç—ã –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é—Ç—Å—è! –î–ª—è –±–æ–ª—å—à–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–æ–∑–¥–∞–π—Ç–µ Issue –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è.

## üìù License

MIT

## üë§ Author

**Artur Komarov** ([@KomarovAI](https://github.com/KomarovAI))
