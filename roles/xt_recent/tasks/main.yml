---
- name: Configure xt_recent kernel module parameters
  copy:
    content: |
      # Increase xt_recent limits for tracking more IPs
      options xt_recent ip_list_tot={{ xt_recent_ip_list_tot }} ip_pkt_list_tot={{ xt_recent_ip_pkt_list_tot }}
    dest: /etc/modprobe.d/xt_recent.conf
    mode: '0644'

- name: Load xt_recent module with new parameters
  modprobe:
    name: xt_recent
    state: present

- name: Check if SSH tracking rule exists
  shell: iptables -S INPUT | grep -q 'ssh_attack.*--set'
  register: ssh_tracking_exists
  failed_when: false
  changed_when: false

- name: Configure SSH rate limiting with xt_recent (tracking)
  shell: |
    iptables -A INPUT -p tcp --dport {{ ssh_port }} -m state --state NEW \
      -m recent --set --name ssh_attack \
      -m comment --comment "Track SSH connection attempts"
  when: ssh_tracking_exists.rc != 0
  notify: Save iptables rules

- name: Check if SSH drop rule exists
  shell: iptables -S INPUT | grep -q 'ssh_attack.*--update'
  register: ssh_drop_exists
  failed_when: false
  changed_when: false

- name: Configure SSH rate limiting with xt_recent (drop)
  shell: |
    iptables -A INPUT -p tcp --dport {{ ssh_port }} -m state --state NEW \
      -m recent --update --seconds {{ ssh_rate_limit_seconds }} --hitcount {{ ssh_rate_limit_hitcount }} --name ssh_attack \
      -j DROP \
      -m comment --comment "Drop SSH brute-force ({{ ssh_rate_limit_hitcount }} attempts in {{ ssh_rate_limit_seconds }}s)"
  when: ssh_drop_exists.rc != 0
  notify: Save iptables rules

- name: Check if port scan tracking rule exists
  shell: iptables -S INPUT | grep -q 'portscan.*--set'
  register: portscan_tracking_exists
  failed_when: false
  changed_when: false

- name: Configure port scan detection with xt_recent (tracking)
  shell: |
    iptables -A INPUT -p tcp -m state --state NEW \
      -m recent --set --name portscan \
      -m comment --comment "Track new TCP connections for port scan detection"
  when: portscan_tracking_exists.rc != 0
  notify: Save iptables rules

- name: Check if port scan log rule exists
  shell: iptables -S INPUT | grep -q 'PORTSCAN DETECTED'
  register: portscan_log_exists
  failed_when: false
  changed_when: false

- name: Log port scan attempts
  shell: |
    iptables -A INPUT -p tcp -m state --state NEW \
      -m recent --update --seconds {{ portscan_seconds }} --hitcount {{ portscan_hitcount }} --name portscan \
      -j LOG --log-prefix '[PORTSCAN DETECTED] ' --log-level warning \
      -m comment --comment "Log port scanners ({{ portscan_hitcount }} ports in {{ portscan_seconds }}s)"
  when: portscan_log_exists.rc != 0
  notify: Save iptables rules

- name: Check if port scan drop rule exists
  shell: iptables -S INPUT | grep -q 'portscan.*DROP'
  register: portscan_drop_exists
  failed_when: false
  changed_when: false

- name: Drop port scan attempts
  shell: |
    iptables -A INPUT -p tcp -m state --state NEW \
      -m recent --update --seconds {{ portscan_seconds }} --hitcount {{ portscan_hitcount }} --name portscan \
      -j DROP \
      -m comment --comment "Drop port scanners"
  when: portscan_drop_exists.rc != 0
  notify: Save iptables rules

- name: Display xt_recent status
  debug:
    msg: |
      âœ… xt_recent kernel-based rate limiting configured!
      
      SSH Protection:
      - Max {{ ssh_rate_limit_hitcount }} attempts per {{ ssh_rate_limit_seconds }} seconds
      - Port: {{ ssh_port }}
      
      Port Scan Detection:
      - Triggers on {{ portscan_hitcount }} ports in {{ portscan_seconds }} seconds
      - Auto-ban at kernel level (no log parsing!)
      
      View tracked IPs:
      - cat /proc/net/xt_recent/ssh_attack
      - cat /proc/net/xt_recent/portscan
      
      Clear tracked IP:
      - echo -1.2.3.4 > /proc/net/xt_recent/ssh_attack